name: CI

on:
    push:
        branches:
            - "**"

jobs:
    quality:
        name: Quality checks
        runs-on: ubuntu-latest
        env:
            ETFS_PROJECT_NAME: ci
            HOST_PROJECT_PATH: ${{ github.workspace }}
        steps:
            - uses: actions/checkout@v4
            - name: Start Docker services
              run: docker compose up --build -d app mariadb
            - name: Install dependencies
              run: |
                  docker compose exec -T app mise trust
                  docker compose exec -T app mise install
                  # Install vendor tasks before using mise run composer
                  docker compose exec -T app composer install
                  docker compose exec -T app mise exec node -- npm install --no-save
            - name: Setup database
              run: |
                  docker compose exec -T app php bin/console doctrine:database:create --if-not-exists
                  docker compose exec -T app php bin/console doctrine:migrations:migrate --no-interaction
            - name: Run quality checks
              run: |
                  docker compose exec -T app mise run quality
                  git diff --exit-code

    tests-php:
        name: PHP tests
        runs-on: ubuntu-latest
        env:
            ETFS_PROJECT_NAME: ci
            HOST_PROJECT_PATH: ${{ github.workspace }}
        steps:
            - uses: actions/checkout@v4
            - name: Start Docker services
              run: docker compose up --build -d app mariadb
            - name: Install dependencies
              run: |
                  docker compose exec -T app mise trust
                  docker compose exec -T app mise install
                  # Install vendor tasks before using mise run composer
                  docker compose exec -T app composer install
                  docker compose exec -T app mise exec node -- npm install --no-save
            - name: Setup database
              run: |
                  docker compose exec -T app php bin/console doctrine:database:create --if-not-exists
                  docker compose exec -T app php bin/console doctrine:migrations:migrate --no-interaction
            - name: Run PHP tests
              run: docker compose exec -T app mise run tests

    tests-frontend:
        name: Frontend tests
        runs-on: ubuntu-latest
        env:
            ETFS_PROJECT_NAME: ci
            HOST_PROJECT_PATH: ${{ github.workspace }}
        steps:
            - uses: actions/checkout@v4
            - name: Start Docker services
              run: docker compose up --build -d app
            - name: Install dependencies
              run: |
                  docker compose exec -T app mise trust
                  docker compose exec -T app mise install
                  # Install vendor tasks before using mise run composer
                  docker compose exec -T app composer install
                  docker compose exec -T app mise exec node -- npm install --no-save
            - name: Run frontend tests
              run: docker compose exec -T app mise run tests:frontend

    build-frontend:
        name: Frontend build
        runs-on: ubuntu-latest
        env:
            ETFS_PROJECT_NAME: ci
            HOST_PROJECT_PATH: ${{ github.workspace }}
        steps:
            - uses: actions/checkout@v4
            - name: Start Docker services
              run: docker compose up --build -d app
            - name: Install dependencies
              run: |
                  docker compose exec -T app mise trust
                  docker compose exec -T app mise install
                  # Install vendor tasks before using mise run composer
                  docker compose exec -T app composer install
                  docker compose exec -T app mise exec node -- npm install --no-save
            - name: Build frontend assets
              run: docker compose exec -T app mise run frontend
